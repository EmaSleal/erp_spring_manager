<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head th:replace="~{layout :: head}">
    <title>Reporte de Ventas</title>
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{components/navbar :: navbar}"></div>

    <!-- Sidebar -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid py-4">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/dashboard}"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="breadcrumb-item"><a th:href="@{/reportes}"><i class="fas fa-chart-bar"></i> Reportes</a></li>
                <li class="breadcrumb-item active" aria-current="page">Ventas</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line text-primary"></i> Reporte de Ventas</h2>
                <p class="text-muted mb-0">Análisis detallado de facturación y ventas</p>
            </div>
            <div class="export-buttons">
                <button type="button" class="btn btn-danger" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
            </div>
        </div>

        <!-- Alertas -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <form th:action="@{/reportes/ventas}" method="get">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="fechaInicio" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Fecha Inicio
                        </label>
                        <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" 
                               th:value="${fechaInicio}">
                    </div>

                    <div class="col-md-3">
                        <label for="fechaFin" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Fecha Fin
                        </label>
                        <input type="date" class="form-control" id="fechaFin" name="fechaFin" 
                               th:value="${fechaFin}">
                    </div>

                    <div class="col-md-4">
                        <label for="clienteId" class="form-label">
                            <i class="fas fa-user"></i> Cliente
                        </label>
                        <select class="form-select" id="clienteId" name="clienteId">
                            <option value="">Todos los clientes</option>
                            <option th:each="cliente : ${clientes}" 
                                    th:value="${cliente.idCliente}"
                                    th:text="${cliente.nombre}"
                                    th:selected="${clienteId != null && clienteId == cliente.idCliente}">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <div class="filter-buttons">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <a th:href="@{/reportes/ventas}" class="btn btn-secondary">
                                <i class="fas fa-redo"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Estadísticas del Reporte -->
        <div th:if="${estadisticas != null}" class="stats-summary slide-down">
            <div class="row">
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value" th:text="${estadisticas.cantidadFacturas}">0</span>
                        <span class="stats-label">Facturas</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value text-money">
                            S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalVentas ?: 0, 1, 2)}">0.00</span>
                        </span>
                        <span class="stats-label">Total Ventas</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value text-money">
                            S/ <span th:text="${#numbers.formatDecimal(estadisticas.ticketPromedio ?: 0, 1, 2)}">0.00</span>
                        </span>
                        <span class="stats-label">Ticket Promedio</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value" th:text="${estadisticas.facturasPagadas}">0</span>
                        <span class="stats-label">Pagadas</span>
                    </div>
                </div>
            </div>
            <hr class="my-3" style="opacity: 0.3;">
            <div class="row">
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value" th:text="${estadisticas.facturasPendientes}">0</span>
                        <span class="stats-label">Pendientes</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value text-money">
                            S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalPagado ?: 0, 1, 2)}">0.00</span>
                        </span>
                        <span class="stats-label">Total Pagado</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value text-money">
                            S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalPendiente ?: 0, 1, 2)}">0.00</span>
                        </span>
                        <span class="stats-label">Por Cobrar</span>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stats-item">
                        <span class="stats-value" th:text="${estadisticas.facturasEntregadas}">0</span>
                        <span class="stats-label">Entregadas</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Resultados -->
        <div class="card shadow-sm fade-in">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-table text-primary"></i> 
                    Listado de Facturas
                    <span th:if="${facturas != null && !facturas.isEmpty()}" 
                          class="badge bg-primary ms-2" th:text="${facturas.size()}">0</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div th:if="${facturas != null && !facturas.isEmpty()}" class="table-responsive">
                    <table class="table table-report table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 12%;">Número</th>
                                <th style="width: 10%;">Fecha</th>
                                <th style="width: 20%;">Cliente</th>
                                <th style="width: 10%;" class="text-end">Subtotal</th>
                                <th style="width: 8%;" class="text-end">IGV</th>
                                <th style="width: 10%;" class="text-end">Total</th>
                                <th style="width: 10%;" class="text-center">Estado Pago</th>
                                <th style="width: 10%;" class="text-center">Entrega</th>
                                <th style="width: 5%;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="factura, iterStat : ${facturas}">
                                <td th:text="${iterStat.count}">1</td>
                                <td>
                                    <strong th:text="${factura.numeroFactura}">F001-0001</strong>
                                </td>
                                <td th:text="${#dates.format(factura.createDate, 'dd/MM/yyyy')}">01/01/2024</td>
                                <td>
                                    <span th:text="${factura.cliente?.nombre}">Cliente</span>
                                </td>
                                <td class="text-end text-money">
                                    S/ <span th:text="${#numbers.formatDecimal(factura.subtotal ?: 0, 1, 2)}">0.00</span>
                                </td>
                                <td class="text-end text-money">
                                    S/ <span th:text="${#numbers.formatDecimal(factura.igv ?: 0, 1, 2)}">0.00</span>
                                </td>
                                <td class="text-end">
                                    <strong class="text-money">
                                        S/ <span th:text="${#numbers.formatDecimal(factura.total ?: 0, 1, 2)}">0.00</span>
                                    </strong>
                                </td>
                                <td class="text-center">
                                    <span th:if="${factura.fechaPago != null}" class="badge badge-estado badge-pagada">
                                        <i class="fas fa-check-circle"></i> Pagada
                                    </span>
                                    <span th:unless="${factura.fechaPago != null}" class="badge badge-estado badge-pendiente">
                                        <i class="fas fa-clock"></i> Pendiente
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span th:if="${factura.entregado}" class="badge badge-estado badge-entregada">
                                        <i class="fas fa-truck"></i> Entregada
                                    </span>
                                    <span th:unless="${factura.entregado}" class="badge badge-estado badge-no-entregada">
                                        <i class="fas fa-box"></i> Pendiente
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a th:href="@{/facturas/editar/{id}(id=${factura.idFactura})}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td colspan="4" class="text-end"><strong>TOTALES:</strong></td>
                                <td class="text-end text-money">
                                    <strong>S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalVentas - estadisticas.totalVentas * 0.18 / 1.18 ?: 0, 1, 2)}">0.00</span></strong>
                                </td>
                                <td class="text-end text-money">
                                    <strong>S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalVentas * 0.18 / 1.18 ?: 0, 1, 2)}">0.00</span></strong>
                                </td>
                                <td class="text-end text-money">
                                    <strong>S/ <span th:text="${#numbers.formatDecimal(estadisticas.totalVentas ?: 0, 1, 2)}">0.00</span></strong>
                                </td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Empty State -->
                <div th:if="${facturas == null || facturas.isEmpty()}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h5>No hay facturas para mostrar</h5>
                    <p>No se encontraron facturas con los filtros seleccionados.</p>
                    <a th:href="@{/reportes/ventas}" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Limpiar Filtros
                    </a>
                </div>
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle text-primary"></i> Información del Reporte</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Período:</strong> 
                                    <span th:if="${fechaInicio != null && fechaFin != null}">
                                        Del <span th:text="${fechaInicio}"></span> al <span th:text="${fechaFin}"></span>
                                    </span>
                                    <span th:unless="${fechaInicio != null && fechaFin != null}">
                                        Todas las fechas
                                    </span>
                                </p>
                                <p><strong>Cliente:</strong> 
                                    <span th:if="${clienteId != null}">
                                        <span th:each="c : ${clientes}" th:if="${c.idCliente == clienteId}" th:text="${c.nombre}"></span>
                                    </span>
                                    <span th:unless="${clienteId != null}">Todos</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Generado:</strong> <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy HH:mm')}"></span></p>
                                <p><strong>Usuario:</strong> <span th:text="${userName}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6><i class="fas fa-lightbulb text-warning"></i> Consejos</h6>
                        <ul class="small mb-0">
                            <li>Usa los filtros para análisis específicos</li>
                            <li>Exporta a Excel para análisis avanzado</li>
                            <li>El ticket promedio ayuda a medir rentabilidad</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Ventas -->
        <div class="row mt-4" th:if="${facturas != null && !facturas.isEmpty()}">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-area text-primary"></i> Visualización de Ventas
                        </h5>
                        <p class="text-muted small">Distribución de ventas en el período seleccionado</p>
                        <canvas id="ventasChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <div th:replace="~{layout :: scripts}"></div>
    <script th:src="@{/js/reportes.js}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        
        // Auto-ocultar alertas
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });

        // Exportar a PDF
        function exportarPDF() {
            Swal.fire({
                title: 'Exportar a PDF',
                text: '¿Deseas exportar este reporte a PDF?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-file-pdf"></i> Exportar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Obtener parámetros actuales
                    const urlParams = new URLSearchParams(window.location.search);
                    const fechaInicio = urlParams.get('fechaInicio') || '';
                    const fechaFin = urlParams.get('fechaFin') || '';
                    const clienteId = urlParams.get('clienteId') || '';
                    
                    // Construir URL de exportación
                    const exportUrl = /*[[@{/reportes/ventas/exportar/pdf}]]*/ '/reportes/ventas/exportar/pdf' + 
                                     '?' +
                                     (fechaInicio ? 'fechaInicio=' + fechaInicio + '&' : '') +
                                     (fechaFin ? 'fechaFin=' + fechaFin + '&' : '') +
                                     (clienteId ? 'clienteId=' + clienteId : '');
                    
                    window.location.href = exportUrl.replace(/&$/, '').replace(/\?$/, '');
                    
                    Swal.fire({
                        title: 'Exportando...',
                        text: 'Generando archivo PDF',
                        icon: 'info',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Exportar a Excel
        function exportarExcel() {
            Swal.fire({
                title: 'Exportar a Excel',
                text: '¿Deseas exportar este reporte a Excel?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-file-excel"></i> Exportar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Obtener parámetros actuales
                    const urlParams = new URLSearchParams(window.location.search);
                    const fechaInicio = urlParams.get('fechaInicio') || '';
                    const fechaFin = urlParams.get('fechaFin') || '';
                    const clienteId = urlParams.get('clienteId') || '';
                    
                    // Construir URL de exportación
                    const exportUrl = /*[[@{/reportes/ventas/exportar/excel}]]*/ '/reportes/ventas/exportar/excel' + 
                                     '?' +
                                     (fechaInicio ? 'fechaInicio=' + fechaInicio + '&' : '') +
                                     (fechaFin ? 'fechaFin=' + fechaFin + '&' : '') +
                                     (clienteId ? 'clienteId=' + clienteId : '');
                    
                    window.location.href = exportUrl.replace(/&$/, '').replace(/\?$/, '');
                    
                    Swal.fire({
                        title: 'Exportando...',
                        text: 'Generando archivo Excel',
                        icon: 'info',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Renderizar gráfico de ventas si hay datos
        /*[# th:if="${facturas != null && !facturas.isEmpty()}" ]*/
        document.addEventListener('DOMContentLoaded', function() {
            renderizarGraficoVentas();
        });

        function renderizarGraficoVentas() {
            const ctx = document.getElementById('ventasChart');
            if (!ctx) return;

            // Datos de ventas (Thymeleaf inline)
            const facturas = /*[[${facturas}]]*/ [];
            
            if (facturas.length === 0) return;

            // Agrupar ventas por día
            const ventasPorDia = {};
            facturas.forEach(factura => {
                const fecha = new Date(factura.fechaEmision).toLocaleDateString('es-PE');
                if (!ventasPorDia[fecha]) {
                    ventasPorDia[fecha] = 0;
                }
                ventasPorDia[fecha] += parseFloat(factura.total || 0);
            });

            // Convertir a arrays
            const labels = Object.keys(ventasPorDia);
            const data = Object.values(ventasPorDia);

            // Crear gradiente
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(13, 110, 253, 0.6)');
            gradient.addColorStop(1, 'rgba(13, 110, 253, 0.1)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas (S/)',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: '#0d6efd',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#0d6efd',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return 'Ventas: S/ ' + context.parsed.y.toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }
        /*[/]*/

        /*]]>*/
    </script>
    </main>
</body>
</html>
